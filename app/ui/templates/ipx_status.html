<!doctype html>
<html>
<head>
  
  <meta charset="utf-8" />
  <title>IPX Outputs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/static/menu.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">
  <div class="max-w-5xl mx-auto p-4 space-y-6">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-2xl font-bold">IPX – Output Status</h1>
      <div class="flex items-center gap-3">
        <label for="max-relays" class="text-sm opacity-80">Show relays:</label>
        <select id="max-relays" class="bg-slate-800 rounded px-2 py-1">
          <option>8</option>
          <option selected>16</option>
          <option>24</option>
          <option>32</option>
        </select>
        <button id="refresh" class="rounded px-3 py-1 bg-slate-700">Refresh</button>
        <a href="/" class="text-sm underline opacity-90">← Home</a>
      </div>
    </header>

    <div id="status" class="text-sm opacity-80"></div>

    <div id="grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3"></div>
  </div>

  <script>
    // --- Helpers ---
    const LS_KEY = 'ipx.maxRelays';
    let inFlight = false;
    let timer = null;

    function getMaxRelays() {
      const v = localStorage.getItem(LS_KEY);
      const el = document.getElementById('max-relays');
      if (v) el.value = v;
      return parseInt(el.value || '16', 10);
    }

    function setMaxRelays(v) {
      localStorage.setItem(LS_KEY, String(v));
    }

    async function load(maxRelays) {
      const r = await fetch(`/ipx/status?max_relays=${maxRelays}`);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function renameRelay(relay, currentName) {
      const name = prompt(`Name for relay R${relay}:`, currentName || "");
      if (name === null) return null; // user cancelled
      const r = await fetch('/ipx/names', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ relay, name })
      });
      if (!r.ok) throw new Error(await r.text());
      const { name: saved } = await r.json();
      return saved || null;
    }

    function render(data) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      data.relays.forEach(item => {
        const on = !!item.on;
        const label = (item.name && item.name.trim()) ? item.name : `Relay ${item.relay}`;
        const div = document.createElement('div');
        div.className = `rounded-xl p-3 text-center shadow ${on ? 'bg-green-600' : 'bg-slate-800'}`;
        div.innerHTML = `
          <div class="text-xs opacity-80">R${item.relay}</div>
          <button class="text-base font-semibold underline decoration-dotted truncate" title="Click to rename">${label}</button>
          <div class="text-lg font-bold mt-1">${on ? 'ON' : 'OFF'}</div>
        `;
        const btn = div.querySelector('button');
        btn.onclick = async () => {
          try {
            const newName = await renameRelay(item.relay, item.name);
            if (newName !== null) {
              btn.textContent = newName.trim() ? newName : `Relay ${item.relay}`;
              // Optimistically update local item.name so a fast refresh keeps it
              item.name = newName;
            }
          } catch (e) {
            alert('Rename failed: ' + e.message);
          }
        };
        grid.appendChild(div);
      });
      if (!data.relays.length) {
        grid.textContent = 'No relays returned.';
      }
    }

    async function refresh() {
      if (inFlight) return;         // avoid overlapping calls
      inFlight = true;
      const status = document.getElementById('status');
      const maxRelays = getMaxRelays();
      try {
        status.textContent = 'Loading…';
        const data = await load(maxRelays);
        render(data);
        status.textContent = `Relays returned: ${data.relays.length} (updated ${new Date().toLocaleTimeString()})`;
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        document.getElementById('grid').innerHTML = '';
      } finally {
        inFlight = false;
      }
    }

    function scheduleAutoRefresh() {
      if (timer) clearInterval(timer);
      timer = setInterval(refresh, 10000); // 10s
    }

    // --- Wire UI ---
    document.getElementById('refresh').onclick = refresh;
    document.getElementById('max-relays').onchange = (e) => {
      const val = parseInt(e.target.value, 10) || 16;
      setMaxRelays(val);
      refresh();
    };

    // Init
    getMaxRelays();   // sync select from localStorage
    scheduleAutoRefresh();
    refresh();
  </script>
</body>
</html>

