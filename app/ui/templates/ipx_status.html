{% extends "base.html" %}
{% block title %}IPX Outputs · HomeHub{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-semibold">IPX – Output Status</h1>
  <div class="flex items-center gap-3">
    <label for="max-relays" class="text-sm opacity-80">Show relays:</label>
    <select id="max-relays" class="bg-slate-800 rounded px-2 py-1 border border-slate-700">
      <option>8</option><option selected>16</option><option>24</option><option>32</option>
    </select>
    <button id="refresh" class="rounded px-3 py-1 bg-slate-800 hover:bg-slate-700 border border-slate-700">Refresh</button>
  </div>
</div>

<div id="status" class="text-sm opacity-80 mb-2"></div>
<div id="grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3"></div>

<script>
const LS_KEY = 'ipx.maxRelays';
let inFlight = false;

function getMaxRelays() {
  const v = localStorage.getItem(LS_KEY);
  const el = document.getElementById('max-relays');
  if (v) el.value = v;
  return parseInt(el.value || '16', 10);
}
function setMaxRelays(v){ localStorage.setItem(LS_KEY, String(v)); }
async function load(maxRelays){
  const r = await fetch(`/ipx/status?max_relays=${maxRelays}`);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function renameRelay(relay, currentName){
  const name = prompt(`Name for relay R${relay}:`, currentName || "");
  if (name === null) return null;
  const r = await fetch('/ipx/names', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ relay, name })});
  if(!r.ok) throw new Error(await r.text());
  const j = await r.json();
  return j.name ?? name;
}
function render(data){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  data.relays.forEach(item => {
    const on = !!item.on;
    const label = (item.name && item.name.trim()) ? item.name : `Relay ${item.relay}`;
    const div = document.createElement('div');
    div.className = `rounded-xl p-3 text-center shadow border border-slate-700 ${on ? 'bg-emerald-700/70' : 'bg-slate-800/60'}`;
    div.innerHTML = `
      <div class="text-xs opacity-80">R${item.relay}</div>
      <button class="text-base font-semibold underline decoration-dotted truncate" title="Click to rename">${label}</button>
      <div class="text-lg font-bold mt-1">${on ? 'ON' : 'OFF'}</div>
    `;
    div.querySelector('button').onclick = async () => {
      try {
        const newName = await renameRelay(item.relay, item.name);
        if (newName !== null) {
          item.name = newName;
          div.querySelector('button').textContent = newName.trim() ? newName : `Relay ${item.relay}`;
        }
      } catch(e){ alert('Rename failed: ' + e.message); }
    };
    grid.appendChild(div);
  });
  if (!data.relays.length) grid.textContent = 'No relays returned.';
}
async function refresh(){
  if(inFlight) return;
  inFlight = true;
  const status = document.getElementById('status');
  const maxRelays = getMaxRelays();
  try {
    status.textContent = 'Loading…';
    const data = await load(maxRelays);
    render(data);
    status.textContent = `Relays returned: ${data.relays.length} (updated ${new Date().toLocaleTimeString()})`;
  } catch(e){
    status.textContent = 'Error: ' + e.message;
    document.getElementById('grid').innerHTML = '';
  } finally { inFlight = false; }
}
document.getElementById('refresh').onclick = refresh;
document.getElementById('max-relays').onchange = (e) => { setMaxRelays(parseInt(e.target.value,10)||16); refresh(); };
getMaxRelays(); refresh();
</script>
{% endblock %}
