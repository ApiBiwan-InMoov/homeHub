{% extends "base.html" %}
{% block title %}Inputs · HomeHub{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-6 flex items-center justify-between">
  <span>Inputs</span>
  <div class="space-x-2">
    <a href="/inputs/config" class="px-3 py-1 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-sm">Configure</a>
    <button id="btn-refresh" class="px-3 py-1 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-sm">
      Refresh
    </button>
  </div>
</h1>

<div class="grid md:grid-cols-2 gap-6">
  <div>
    <h2 class="text-lg font-semibold mb-2">Digital</h2>
    <div id="digital" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
  </div>
  <div>
    <h2 class="text-lg font-semibold mb-2">Analog</h2>
    <div id="analog" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
  </div>
</div>

<script>
async function loadStatus() {
  const r = await fetch('/inputs/status?max_buttons=32&max_analogs=16', { cache: 'no-store' });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function el(tag, className, text) {
  const d = document.createElement(tag);
  if (className) d.className = className;
  if (text !== undefined && text !== null) d.textContent = text;
  return d;
}

function makeEditButton(type, index, currentName, onSaved) {
  const btn = el('button',
    'absolute top-2 right-2 text-xs opacity-70 hover:opacity-100 px-2 py-0.5 rounded bg-slate-700/60 border border-slate-600'
  , '✎');
  btn.title = 'Rename';
  btn.addEventListener('click', async (ev) => {
    ev.stopPropagation();
    const name = prompt(`Rename ${type.toUpperCase()}${index}`, currentName || '');
    if (name === null) return;
    try {
      const r = await fetch('/inputs/name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, index, name: name || null }),
      });
      if (!r.ok) throw new Error(await r.text());
      onSaved && onSaved(name || null);
    } catch (e) {
      alert('Rename failed: ' + e.message);
    }
  });
  return btn;
}

function digitalCard(item) {
  // item: { index, on, name }
  const on = !!item.on;
  const card = el('div',
    `relative rounded-xl p-3 border ${on ? 'border-emerald-500/40 bg-emerald-700/70' : 'border-slate-700 bg-slate-800/60'}`
  );

  const title = el('div', 'text-[11px] uppercase tracking-wide opacity-70');
  title.textContent = `B${item.index}` + (item.name ? ` · ${item.name}` : '');

  const status = el('div', 'text-lg font-semibold mt-1', on ? 'ON' : 'OFF');

  card.appendChild(title);
  card.appendChild(status);
  card.appendChild(makeEditButton('digital', item.index, item.name, (newName) => {
    title.textContent = `B${item.index}` + (newName ? ` · ${newName}` : '');
  }));
  return card;
}

function analogCard(item) {
  // item: { index, name, volts, value, unit, decimals, text, mode }
  const card = el('div', 'relative rounded-xl p-3 border border-slate-700 bg-slate-800/60');

  const title = el('div', 'text-[11px] uppercase tracking-wide opacity-70');
  title.textContent = `A${item.index}` + (item.name ? ` · ${item.name}` : '');

  const main = el('div', 'text-lg font-semibold mt-1');
  main.textContent = item.text ?? '—';

  const sub = el('div', 'text-[12px] opacity-70 mt-0.5');
  // Show volts as a helper line; if unknown, show mode
  if (item.volts !== null && item.volts !== undefined) {
    try {
      const v = Number(item.volts);
      sub.textContent = isFinite(v) ? `${v.toFixed(3)} V` : '—';
    } catch {
      sub.textContent = '—';
    }
  } else {
    sub.textContent = item.mode ? `mode: ${item.mode}` : '';
  }

  card.appendChild(title);
  card.appendChild(main);
  card.appendChild(sub);
  card.appendChild(makeEditButton('analog', item.index, item.name, (newName) => {
    title.textContent = `A${item.index}` + (newName ? ` · ${newName}` : '');
  }));
  return card;
}

async function render() {
  const data = await loadStatus();

  // Digital
  const dWrap = document.getElementById('digital');
  dWrap.innerHTML = '';
  (data.digital || []).forEach((x) => dWrap.appendChild(digitalCard(x)));

  // Analog
  const aWrap = document.getElementById('analog');
  aWrap.innerHTML = '';
  (data.analog || []).forEach((x) => aWrap.appendChild(analogCard(x)));
}

(function init(){
  // Manual refresh
  document.getElementById('btn-refresh').addEventListener('click', () => {
    render().catch(e => alert('Failed to load inputs: ' + e.message));
  });
  // Auto refresh every 3s
  render().catch(e => alert('Failed to load inputs: ' + e.message));
  setInterval(() => {
    render().catch(() => {/* ignore periodic errors */});
  }, 3000);
})();
</script>
{% endblock %}
